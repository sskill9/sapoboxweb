# Multiple Choice Questions ツール 仕様書（確定版）

## 1. 目的
本ツールは、新人教育における日別理解度テストや、定期的なセキュリティテスト等を目的とした  
**ローカル完結型 Multiple Choice Questions（選択式テスト）ツール**である。

ネットワーク接続やサーバー環境を前提とせず、`file://` での起動を前提とする。  
回答の事前閲覧を防ぐため、**SV（管理者）による採点キー入力方式**を採用する。

---

## 2. 前提条件・制約
- 完全ローカル動作（オフライン可）
- CORS問題回避のため **JSONファイルは使用しない**
- 設問データは **JavaScriptファイル（testpack.js）で定義**
- 結果は **TXTファイルとしてダウンロード出力**
- 対応ブラウザ：Chrome / Edge
- 文字コード：UTF-8

---

## 3. 役割
### 管理者 / SV
- 設問作成
- 採点キー設定（固定）
- 採点実施
- 合否確認

### 受講者
- 受験
- 回答提出
- 採点キー入力は行わない（運用ルール）

---

## 4. 運用フロー（確定）
1. 管理者 / SV が作成ツールで設問を作成し、`testpack.js` を生成
2. 受講者が `index.html` をローカルで開き受験
3. 回答提出後、「SVを呼んでください」画面を表示
4. SVが採点キーを入力し **ENTER** を押す
5. 画面に **合否 + 正解率（小数第1位）** を表示
6. 同時に結果TXTを **ダウンロード形式で出力**

※ 保存先はブラウザ設定に依存し、アクセス権の影響を受けない

---

## 5. 設問形式
- 単一選択（single）
- 複数選択（multi）

### 複数選択の採点ルール
- 正解セットと **完全一致** した場合のみ正解
- 過不足が1つでもあれば不正解

---

## 6. スコア・合否判定
- 正解率 = (正解数 / 問題数) × 100
- 表示形式：**小数第1位まで（四捨五入）**
- 合否判定：正解率 >= 合格ライン（％）

---

## 7. ファイル構成（T012_MCQs01 / テンプレ統合方針）
- T012index.html ：エントリ（テンプレ）。top.js / content.js / footer.js / 各モーダルを読み込む
- top.js ：TOPバー（テンプレ共通）※ツール名・ZIPリンクは後で手動修正
- content.js ：本体UI（受験UI＋作成UI）※このファイルを中心に実装
- footer.js ：共通フッター（利用規約ボタン含む）
- modal-howto.js ：使い方モーダル（このツール向けに文面更新）
- modal-links.js ：リンクモーダル（必要に応じて更新）
- modal-changelog.js ：更新履歴モーダル（このツール向けに更新）
- modal-terms.js ：利用規約モーダル（サポ箱共通。原則編集しない）
- testpack.js ：設問データ（暗号化済み正解を含む）
- app.js ：受験・採点ロジック
- builder.js ：作成ツール（testpack.js 生成）
- crypto.js ：暗号処理（CryptoJS呼び出し＋ユーティリティ）
- libs/crypto-js/ ：CryptoJS 本体（ZIP同梱）

---

## 8. testpack.js の基本方針
- `<script>` 読み込み
- `window.TESTPACK = { ... }` 形式で定義
- 平文の正解は保持しない
- 正解は暗号化済みデータ（answerEnc）として保持
- 暗号方式は「抑止目的」前提でシンプル構成（CryptoJS / AES-CBC + PBKDF2 / MACなし）

---

## 9. 採点キー仕様
- テスト作成時に **固定キー** を設定
- 採点時にSVが入力
- 以下は禁止
  - 画面表示
  - ファイル保存
  - コンソール出力
  - localStorage保存

---

## 10. 結果TXTファイル仕様

### 10.1 ファイル名
```
社員番号_氏名_テスト名_合否_YYYYMMDD-HHMMSS.txt
```

### 10.2 ファイル名サニタイズ
- 禁止文字： \ / : * ? " < > |  
- 上記および改行・タブは `_` に置換

---

### 10.3 TXT内容（共通）
- テスト名
- テストID
- 社員番号
- 氏名
- 受験開始日時（JST）
- 提出日時（JST）
- 所要時間（秒）
- 正解数 / 問題数
- 正解率（％ 小数第1位）
- 合否（合格ライン含む）
- 採点日時（JST）
- attemptId

---

### 10.4 合格時のみ追加出力
```
---- 設問別結果（合格時のみ） ----
[Q001] 問題文：正解
[Q002] 問題文：不正解
...
```

- 各設問の **正解 / 不正解のみ**
- 正しい選択肢や解説文は出力しない
- 不合格時は設問別結果を出力しない

---

## 11. セキュリティ方針（ローカル前提）
- 平文の正解を置かない
- 採点キーはSVのみが知る
- 技術的完全防御ではなく、運用と抑止を重視

---

# 完成までにやるべき項目（TODO）

## フェーズ1：設計確定
- [x] 運用フロー確定
- [x] 採点方式確定（SVキー方式）
- [x] 結果TXT仕様確定
- [x] 出力内容（合格時の設問別正誤）確定

## フェーズ2：設問作成ツール
- [ ] 管理者UI設計
- [ ] 単一選択 / 複数選択の入力UI
- [ ] 採点キー入力UI
- [ ] 正解暗号化処理
- [ ] testpack.js 自動生成

## フェーズ3：受験・採点機能
- [ ] 受講者情報入力画面
- [ ] 問題表示（シャッフル対応）
- [ ] 回答ロック処理
- [ ] ENTERキーによる採点実行
- [ ] 正解率計算（小数第1位）
- [ ] 合否表示

## フェーズ4：結果出力
- [ ] TXT内容生成
- [ ] ファイル名サニタイズ
- [ ] ダウンロード処理実装（Blob + a.download）

## フェーズ5：品質確認
- [ ] file:// 起動確認
- [ ] CORSエラーが出ないことの確認
- [ ] 不合格時に詳細が出ないことの確認
- [ ] 日本語文字化け確認
- [ ] 再受験時の挙動確認

---

## 12. testpack.js フォーマット v1（確定）

### 12.1 形式（トップレベル）
- `meta`（必須）
- `security`（必須）
- `questions`（必須：配列、0件不可）

### 12.2 meta（必須項目）
- `formatVersion` : string（例 `"1.0"`）
- `testId` : string（ユニーク推奨）
- `testName` : string
- `createdAt` : string（ISO 8601 / JST `+09:00` を含める）
- `passLinePercent` : number（0〜100）
- `shuffleQuestions` : boolean
- `shuffleChoices` : boolean
- `locale` : string（例 `"ja-JP"`）

### 12.3 security（必須項目：CryptoJS用）
- `scheme` : `"cj-aes-cbc-pbkdf2"`
- `kdf` :
  - `name` : `"PBKDF2"`
  - `hash` : `"SHA-256"`
  - `iterations` : `300000`
- `cipher` :
  - `name` : `"AES-CBC"`
  - `keyLength` : `256`
- `saltB64` : string（Base64 / テスト全体共通）

### 12.4 questions[]（各要素の必須）
- `qid` : string（例 `"Q001"`。ファイル内ユニーク）
- `type` : `"single"` または `"multi"`
- `body` : string（問題文）
- `choices` : array（2件以上）
  - `cid` : string（`"A"|"B"|"C"...` 推奨）
  - `text` : string（選択肢文）
- `answerEnc` : object（暗号化済み正解）
  - `alg` : `"AES-CBC"`（推奨）
  - `ivB64` : string（Base64 / 16バイトIV）
  - `dataB64` : string（Base64 / 暗号文）

### 12.5 復号後データ仕様（採点の基準）
- 復号結果は **CID配列のJSON文字列**（UTF-8）とする
  - single例：`'["B"]'`
  - multi例：`'["A","B","D"]'`
- 採点前に正規化する（復号結果・受講者回答とも同じ）
  - CID重複除去
  - 文字列昇順ソート
  - 配列完全一致で判定（multiは過不足1つでも不正解）

---

## 13. 暗号仕様（確定：抑止目的・シンプル構成）

### 13.1 採用方式
- CryptoJS を利用
- **AES-CBC + PBKDF2（SHA-256）**
- **MAC（改ざん検知）なし**（抑止目的のためシンプル優先）

### 13.2 salt / iv ルール（確定）
- `salt`：16バイト乱数（テスト全体で共通）→ `saltB64`
- `iv`：16バイト乱数（設問ごとに生成）→ `answerEnc.ivB64`

### 13.3 採点キー（SVキー）仕様（確定）
- 作成者が設定する固定キー：**数字4桁**
- 正規化ルール：
  - 前後トリム
  - 数字以外が混じる場合はエラー
  - 4桁未満は左ゼロ埋め（例：`"7"` → `"0007"`）
  - 4桁超はエラー
- 禁止：画面表示／ファイル保存／コンソール出力／localStorage保存（運用ルールとして維持）

### 13.4 注意（前提の明文化）
- 本方式は「正解の平文露出を避ける」ための抑止を目的とする
- 技術的完全防御ではなく、運用と抑止を重視する（強い攻撃者への完全耐性は目的外）

---

## 14. UI・実装方針（確定：T012テンプレ統合＋案1）

### 14.1 実装方針
- `content.js` に「受験UI＋作成UI」を実装する
- ツール名とZIPリンクは後で手動修正するため、現時点ではテンプレのまま進行する

### 14.2 画面構成（content.js）
- Bootstrap Tabs（または Pills）で2モードに分ける
  - タブ1：受験
  - タブ2：作成

### 14.3 受験の問題表示方式（確定：案1）
- **1問ずつ表示**（次へ／前へ）
- 受験開始時に attemptId を生成し固定する

### 14.4 attemptId 仕様（確定）
- 形式：`AT-YYYYMMDD-HHMMSS-XXXXXX`
  - `YYYYMMDD-HHMMSS`：受験開始日時（JST）
  - `XXXXXX`：6桁ランダム（Base36：0-9A-Z）
- 保存方針：メモリ上のみ（永続保存しない）
- 結果TXT本文に必ず出力する

---

# 完成までにやるべき項目（TODO：更新版）

## フェーズ1：設計確定
- [x] 運用フロー確定（結果はTXTダウンロード）
- [x] 採点方式確定（SVキー方式）
- [x] 結果TXT仕様確定（合格時のみ設問別 正誤一覧）
- [x] testpack.js フォーマット v1 確定（meta/security/questions）
- [x] 暗号方式確定（CryptoJS / AES-CBC + PBKDF2 / MACなし）
- [x] attemptId 仕様確定
- [x] 受験UIの問題表示方式確定（案1：1問ずつ）

## フェーズ2：作成ツール（builder.js）
- [ ] 作成UI設計（meta入力＋設問編集）
- [ ] 単一選択 / 複数選択の入力UI
- [ ] SVキー入力UI（4桁正規化・バリデーション）
- [ ] salt生成（16B Base64）・iv生成（16B Base64）
- [ ] 正解暗号化処理（PBKDF2→AES-CBC）
- [ ] testpack.js 自動生成（ダウンロード）

## フェーズ3：受験・採点（app.js）
- [ ] 受講者情報入力（社員番号・氏名）
- [ ] 受験開始処理（attemptId生成・開始時刻確定）
- [ ] 1問ずつ表示UI（次へ／前へ／進捗表示）
- [ ] 回答保持と提出ロック
- [ ] 「SVを呼んでください」画面
- [ ] ENTERキーで採点（SVキー入力）
- [ ] 正解率計算（小数第1位、四捨五入）・合否表示

## フェーズ4：結果出力
- [ ] TXT内容生成（10.3準拠）
- [ ] ファイル名サニタイズ（10.2準拠）
- [ ] ダウンロード処理（Blob + a.download）
- [ ] 合格時のみ「設問別 正誤」を付与（正解選択肢は出力しない）

## フェーズ5：品質確認
- [ ] file:// 起動確認（Chrome / Edge）
- [ ] CORSエラーが出ないことの確認
- [ ] 不合格時に詳細が出ないことの確認
- [ ] 日本語文字化け確認（UTF-8）
- [ ] 再受験時の挙動確認（attemptId重複しないこと）


---

# 【追加】2026-01-03 進捗サマリ＆残タスク（追記分）

## A. 本日までの確定進捗
- testpack 複数読込（sample / pc / security）が安定動作
- 実行HTMLと編集HTMLの乖離問題を解消（実行URL確認ルール確立）
- デバッグコードと本体コードの境界を明文化
- file:// 実行前提での運用フローを再確認

## B. 技術的に確定した重要ルール
- HTML内の `<script src="./testpacks/*.js">` が唯一の読込定義
- window.TESTPACKS は testpack 側で push される
- script削除＝TESTPACKS消失、という依存関係を明示
- デバッグ用 alert / console / DOM 表示は禁止（本体から分離）

## C. 完成までの残実装（再整理）
- builder.js（作成UI）
- app.js（受験・採点・合否判定）
- TXTダウンロード（Blob）
- UI仕上げ（進捗表示／操作制御）
- 最終動作確認（Chrome / Edge）

## D. 次スレッド引き継ぎ要約
T012_MCQs01 は testpack 複数読込・仕様確定まで完了。
本MDは「元仕様＋進捗追記」の統合版。
次工程は builder.js もしくは app.js 実装から再開可能。


---

# 【追記】2026-01-04 時点の進捗・変更点・残作業まとめ

## 1. 本日までに完了した実装・修正（追記）

### 1.1 UI／UX 改善（受験画面）
- 「受験開始」ボタン  
  - 社員番号／氏名／実施テストの未入力時は押下不可
  - 未達条件がある場合、Bootstrap Tooltip にて理由を表示
- 「回答を提出」ボタン  
  - 全設問に選択が行われていない場合は押下不可
  - 表示メッセージは簡潔に  
    →「選択していない設問があります」
- 表示文言の整理  
  - 「SVを呼んでください」→「採点者を呼んでください」
  - その他 SV 表記は削除または中立表現へ変更

### 1.2 結果TXT出力の見直し
- 合格／不合格に関わらず **SVキーを結果TXTに含めない** よう修正
- SVキーは以下を厳守
  - 画面表示しない
  - ファイル出力しない
  - console / localStorage に残さない

### 1.3 リセットボタン挙動修正
- リセット押下時に以下すべてを初期化
  - 実施テスト
  - 社員番号
  - 氏名
  - state 内の受講者情報
- 受験開始ボタンの有効／無効状態も初期状態に戻ることを確認

### 1.4 testpack 読み込み方式の改善（重要）
- 従来：index.html に testpacks/*.js を都度直書き
- 改善後：**JSマニフェスト方式（A-1）を採用**

#### 採用方式
- `testpack-manifest.js` を追加
- index.html は manifest のみを読み込む
- manifest 内で document.write により testpack を同期ロード

#### 効果
- index.html を今後一切修正しなくてよい
- testpacks フォルダには「実テストファイルのみ」を配置する運用を維持
- CORS 制約を完全回避
- app.js の前提（testpack 読込済み）を壊さない

---

## 2. 現在の確定ファイル構成（追記）

- T012index.html  
  - testpack-manifest.js のみを参照
- testpack-manifest.js  
  - 読み込む testpack 一覧を配列で管理
- testpacks/  
  - testpack_*.js（実テストファイルのみ）
- app.js  
  - 受験・採点ロジック（testpack 読込方式変更の影響なし）
- content.js  
  - 受験UI／作成UI、各種バリデーション、Tooltip 制御
- builder.js（未完）
  - testpack 作成ツール（次工程）

---

## 3. 仕様として確定した追加ルール（追記）

### 3.1 UI バリデーション方針
- 押下不可理由は「簡潔・一文」で統一
- Tooltip は Bootstrap 標準機能を利用
- disabled ボタンには直接 Tooltip を付与しない（span ラップ方式）

### 3.2 運用ルール再確認
- SVキーは「採点時入力のみ」
- 受講者・結果ファイル・ログ等へ一切残さない
- 抑止目的の暗号化であり、完全防御は目的外

---

## 4. 残作業一覧（最新・整理版）

### フェーズ2：作成ツール（builder.js）
- 作成UI設計（meta／security／questions）
- 単一選択／複数選択入力UI
- 採点キー（4桁）入力＋正規化
- salt／iv 自動生成
- 正解暗号化処理
- testpack.js ダウンロード生成

### フェーズ3：受験・採点（app.js）
- 回答ロックの最終確認
- ENTERキー採点フローの整理
- 採点失敗時エラーハンドリング整理

### フェーズ4：結果出力
- TXT 内容最終確認（合格／不合格分岐）
- ファイル名命名規則の最終FIX
- JST 時刻表示の最終確認

### フェーズ5：最終確認
- file:// 実行確認（Chrome / Edge）
- 再受験時の state 初期化確認
- 意図しない情報露出が無いことの確認

---

## 5. 次スレッド引き継ぎメモ（追記）

- 本MDは **簡略・省略なし** の正本
- 仕様確定フェーズはほぼ完了
- 次の主作業は builder.js 実装
- UI／UX・運用ルールは本MDを正とする


================================================================
【追記・修正履歴（2026-01-05）】
本仕様書は 2026-01-04 版を正本とし、以下の変更のみを反映した。
既存章・思想・仕様・TODO は削除・要約せず維持している。
================================================================

■ 変更1：設問に「説明（解説）フィールド」を追加
- questions[] に explanation フィールドを追加
- 合格時の結果TXTにのみ出力
- 不合格時は一切出力しない
- 正解選択肢そのものは出力しない

■ 変更2：作成済み設問の再編集機能は検討事項とする
- builder.js フェーズにおいて要否を判断
- 仕様としては未確定（実装義務なし）

■ 変更3：testId フィールド名を fileName に変更
- 結果TXTの識別子として使用
- 人が見て判別しやすい命名を推奨
- testId は廃止し、二重管理を防止

----------------------------------------------------------------

【追記】設問オブジェクトの拡張（questions[]）

- explanation : string
  設問に対する説明・解説。
  合格時の結果TXTにのみ出力される。

----------------------------------------------------------------

【置換】結果TXTファイル名仕様

（旧）
社員番号_氏名_テスト名_合否_YYYYMMDD-HHMMSS.txt

（新）
社員番号_氏名_ファイル名_合否_YYYYMMDD-HHMMSS.txt

----------------------------------------------------------------

【補足】設問再編集機能について（検討事項）

- 一度作成した設問を再編集できるUIを提供するかは未確定とする
- 想定される方式例：
  ・既存 testpack.js を読み込み、編集モードで再構築
  ・新規作成専用とし、再編集は行わない運用
- 実装コスト・運用リスクを考慮し、builder.js フェーズで判断する

================================================================


================================================================
【追記（確定）】仕様補足（変更は追記のみ・既存本文不変）
================================================================

■ 追加1：設問オブジェクトの拡張（保持のみ）
- questions[].explanation : string
  - 設問に対する説明・解説文。
  - 結果TXTには**合格／不合格ともに出力しない**。
  - UI表示・編集用途に限定して保持する。

■ 追加2：SVキー入力UIの運用制約（明文化）
- 採点開始時にのみ入力可能な**一時UI（モーダル等）**で入力する。
- 採点完了後は**即破棄**し、再表示しない。
- 以下は禁止（厳守）
  - 画面への再表示
  - ファイル保存
  - console 出力
  - localStorage 等への保存

■ 追加3：識別子の正本
- 識別子は **testId** を正とする。
- fileName 等への改名・二重管理は行わない。

■ 追加4：平文正解の完全禁止
- 採点は **復号結果（CID配列）** のみを基準とする。
- answerPlain / answerPlainForDevOnly 等の平文参照経路は**禁止**。

■ 追加5：結果TXTの出力範囲（再確認）
- 設問別結果は **正解／不正解のみ**。
- 正解選択肢・解説文は**出力しない**（合格時・不合格時ともに）。
