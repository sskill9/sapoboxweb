# Multiple Choice Questions ツール 仕様書（確定版）

## 1. 目的
本ツールは、新人教育における日別理解度テストや、定期的なセキュリティテスト等を目的とした  
**ローカル完結型 Multiple Choice Questions（選択式テスト）ツール**である。

ネットワーク接続やサーバー環境を前提とせず、`file://` での起動を前提とする。  
回答の事前閲覧を防ぐため、**SV（管理者）による採点キー入力方式**を採用する。

---

## 2. 前提条件・制約
- 完全ローカル動作（オフライン可）
- CORS問題回避のため **JSONファイルは使用しない**
- 設問データは **JavaScriptファイル（testpack.js）で定義**
- 結果は **TXTファイルとしてダウンロード出力**
- 対応ブラウザ：Chrome / Edge
- 文字コード：UTF-8

---

## 3. 役割
### 管理者 / SV
- 設問作成
- 採点キー設定（固定）
- 採点実施
- 合否確認

### 受講者
- 受験
- 回答提出
- 採点キー入力は行わない（運用ルール）

---

## 4. 運用フロー（確定）
1. 管理者 / SV が作成ツールで設問を作成し、`testpack.js` を生成
2. 受講者が `index.html` をローカルで開き受験
3. 回答提出後、「SVを呼んでください」画面を表示
4. SVが採点キーを入力し **ENTER** を押す
5. 画面に **合否 + 正解率（小数第1位）** を表示
6. 同時に結果TXTを **ダウンロード形式で出力**

---

## 5. 設問形式
- 単一選択（single）
- 複数選択（multi）

### 設問の構成要素（共通）
- 問題文
- 選択肢
- 正解（暗号化済み）
- **説明（解説）**（任意だが設定推奨）

### 複数選択の採点ルール
- 正解セットと **完全一致** した場合のみ正解
- 過不足が1つでもあれば不正解

---

## 6. スコア・合否判定
- 正解率 = (正解数 / 問題数) × 100
- 表示形式：**小数第1位まで（四捨五入）**
- 合否判定：正解率 >= 合格ライン（％）

---

## 7. ファイル構成
- index.html
- top.js
- content.js
- app.js
- builder.js
- testpack-manifest.js
- testpack.js

---

## 8. testpack.js の基本方針
- `<script>` 読み込み
- `window.TESTPACK` または `window.TESTPACKS` 形式
- 複数 testpack は `testpack-manifest.js` により同期読み込み
- 平文の正解は保持しない

---

## 9. 採点キー仕様
- 数字4桁
- 正規化：
  - trim
  - 数字以外はエラー
  - 4桁未満は左ゼロ埋め
  - 4桁超はエラー

---

## 10. 結果TXTファイル仕様

### 10.1 ファイル名
```
社員番号_氏名_ファイル名_合否_YYYYMMDD-HHMMSS.txt
```

### 10.2 ファイル名サニタイズ
- 禁止文字： \ / : * ? " < > |
- 改行・タブも `_` に置換

### 10.3 TXT内容（共通）
- ファイル名
- 社員番号
- 氏名
- 受験開始日時（JST）
- 提出日時（JST）
- 正解数 / 問題数
- 正解率
- 合否
- attemptId

### 10.4 合格時のみ追加出力
```
---- 設問別結果（合格時のみ） ----
[Q001] 問題文：正解
  説明：〇〇の理由により△△が正しいため
```

- 正解選択肢は出力しない
- 不合格時は出力しない

---

## 11. セキュリティ方針
- 技術的完全防御は目的外
- 運用と抑止を重視

---

## 12. testpack.js フォーマット v1

### 12.1 トップレベル
- meta
- security
- questions

### 12.2 meta
- formatVersion
- fileName
- testName
- createdAt
- passLinePercent
- shuffleQuestions
- shuffleChoices
- locale

### 12.3 questions
- qid
- type
- text
- choices
- answerEnc
- explanation

---

## 13. 補足：設問再編集機能（検討事項）
- 再編集機能は未確定
- 実装コストと運用リスクを考慮し後続フェーズで判断

---

## 14. 次工程
- 本仕様確定後、builder.js 設計へ進む
