# 入電・応答 ざっくり版ツール 仕様書（拡張込み／確定）

## 0. 目的
入力された「現時点の実績」と「残り時間・見込み入電・人員・CPH」から、以下を即時計算し、現場のざっくり判断に使えること。

- 現在までの応答率
- 業務終了までの予測応答数
- 業務終了までの予測応答率
- （追加）目標応答率に対する「現在／未来」の危険度可視化

## 1. 用語と入力の定義（固定）
- **業務終了までの入電数（`C_end`）**  
  = **今日の業務終了時点の累計入電数の見込み（最終累計）**  
  例：今120件、最終200件見込み → `C_end = 200`

## 2. 入力項目（UI）

### 2-1. 数値入力（手入力）
- `C_now`：現在までの入電数（整数、0以上）
- `A_now`：現在までの応答数（整数、0以上）
- `R_target_pct`：目標応答率（%）（0.0〜100.0、小数可、未入力なら目標判定無効）
- `C_end`：業務終了までの入電数（今日の最終累計見込み）（整数、0以上）
- `CPH`：平均CPH（件/時間/人、0以上、小数可）

### 2-2. 選択入力（セレクト）
- `T_remain`：営業終了までの残り時間（時間、0以上）
- `N_agent`：電話アサイン人数（0以上の整数）

## 3. バリデーション仕様（エラー／警告／補正）

### 3-1. エラー（計算しない）
- **E1：`A_now > C_now`**
  - 意味：応答数が入電数を超えている（入力矛盾）
  - 動作：
    - 結果（応答率、終了予測応答数、終了予測応答率）は **表示しない（またはグレーアウト）**
    - エラーメッセージ表示  
      例：「応答数が入電数を超えています。入力値を確認してください。」

### 3-2. 警告（計算はする）
- **W1：`C_end < C_now`**
  - 意味：最終累計見込みが現時点累計より小さい
  - 動作：
    - 警告メッセージ表示  
      例：「業務終了までの入電見込みが現在の入電数を下回っています。残り入電は0として計算します。」
    - 計算は継続（後述の補正ルール適用）

- **W2：`N_agent = 0` または `T_remain = 0` または `CPH = 0`**
  - 意味：これ以上処理できない前提
  - 動作：
    - 警告メッセージ（任意）  
      例：「残りの処理能力が0として計算されます。」
    - 計算は継続（終了予測は“現状維持”寄りになる）

### 3-3. 補正（内部的に丸め／制約）
- `C_remain = max(0, C_end - C_now)`（残り入電がマイナスなら0）
- `A_end_pred` は最終的に `C_end` を超えないよう制約（後述）
- `R_target_pct` は 0.0〜100.0 に収める（範囲外は入力エラー扱いにしてもよい：実装時に決定）

## 4. 残り時間（`T_remain`）の入力仕様（選択肢）

### 4-1. 刻み
- **30分刻み（0.5時間刻み）**を基本とする  
  理由：現場で扱いやすく、入力が速い

### 4-2. 範囲（例）
- 0, 0.5, 1.0, 1.5, …, 12.0（必要なら上限は後で調整）

※将来拡張：15分刻みや自由入力にもできるが、ざっくり版は「選択式」で固定。

## 5. アサイン人数（`N_agent`）の入力仕様（選択肢）
- **0〜50** をセレクト（センターによって最大50名近くアサインする想定のため）
- ざっくり版なので細かい稼働率（休憩・離席・兼務）は扱わない（CPH側で吸収）

## 6. 出力項目（表示する結果）

### 6-1. 必須の結果
- `R_now_pct_display`：現在までの応答率（%）
- `A_end_pred`：業務終了までの予測応答数（件）
- `R_end_pred_pct_display`：業務終了までの予測応答率（%）

### 6-2. 補助表示（追加で盛り込む仕様）
現場の判断が速くなるため、以下も表示する。

- `C_remain`：残り入電見込み（件）
- `A_capacity_remain`：残り時間での処理能力（件）
- `Delta_capacity`：余力／不足（件）
  - `Delta_capacity = A_capacity_remain - C_remain`
  - 表示例：
    - `Delta_capacity >= 0` → 「余力 +xx件」
    - `Delta_capacity < 0` → 「不足 xx件（取りこぼし見込み）」

### 6-3. 目標応答率（ターゲット）判定の表示（案A）
- `R_target_pct` が **未入力**：ターゲット判定は行わない（背景色の変更・バッジ表示はしない）
- `R_target_pct` が **入力済み**：ターゲット判定を行い、結果パネル全体の背景色＋バッジで危険度を伝える（詳細は 9章）

## 7. 計算ロジック（確定）
前提：**エラー（E1）が発生していない場合のみ計算する**

### (1) 現在までの応答率（%）
- `C_now = 0` の場合：`R_now_pct = 0.0`
- それ以外：
  - `R_now_pct = (A_now / C_now) * 100`
- 表示は **小数1桁**（四捨五入）：`R_now_pct_display = round(R_now_pct, 1)`

### (2) 残り入電見込み（件）
- `C_remain = max(0, C_end - C_now)`

### (3) 残り時間での処理能力（理論上）（件）
- `A_capacity_remain_raw = CPH * N_agent * T_remain`
- 件数の端数は **四捨五入**：
  - `A_capacity_remain = round(A_capacity_remain_raw)`

### (4) 残りで実際に応答できる予測件数（件）
- `A_remain_pred = min(A_capacity_remain, C_remain)`
- 念のため：`A_remain_pred = max(0, A_remain_pred)`

### (5) 業務終了までの予測応答数（件）
- `A_end_pred_raw = A_now + A_remain_pred`
- 入電総数を超えない制約：
  - `A_end_pred = min(A_end_pred_raw, C_end)`

### (6) 業務終了までの予測応答率（%）
- `C_end = 0` の場合：`R_end_pred_pct = 0.0`
- それ以外：
  - `R_end_pred_pct = (A_end_pred / C_end) * 100`
- 表示は **小数1桁**（四捨五入）：`R_end_pred_pct_display = round(R_end_pred_pct, 1)`

### (7) 余力／不足（補助表示）（件）
- `Delta_capacity = A_capacity_remain - C_remain`

## 8. 表示仕様（丸め／単位）
- 応答率：**小数1桁**（四捨五入）＋ `%`
- 件数：整数（`round`済み）＋ `件`
- 時間：選択値を `時間` 表示（例：`3.5時間`）

## 9. 目標応答率（ターゲット）判定・UI仕様（案A：背景はオレンジ一択＋バッジ文言で現在/未来を分ける）

### 9-1. 前提
- `R_target_pct` が入力されている場合のみ判定する。
- エラー（E1）が発生している場合は判定しない（結果表示自体を行わない）。

### 9-2. 判定値
- 現在：`R_now_pct`（丸め前の生値で比較）
- 未来：`R_end_pred_pct`（丸め前の生値で比較）
- 目標：`R_target_pct`

### 9-3. ステータス定義（4状態）
- **S0：OK（現在OK / 予測OK）**  
  条件：`R_now_pct >= R_target_pct` かつ `R_end_pred_pct >= R_target_pct`
- **S1：注意（予測が目標未達）**  
  条件：`R_now_pct >= R_target_pct` かつ `R_end_pred_pct < R_target_pct`
- **S2：危険（現在が目標未達）**  
  条件：`R_now_pct < R_target_pct` かつ `R_end_pred_pct >= R_target_pct`
- **S3：危険（現在も予測も目標未達）**  
  条件：`R_now_pct < R_target_pct` かつ `R_end_pred_pct < R_target_pct`

### 9-4. 背景色（結果パネル全体）
- S0：通常背景
- S1 / S2 / S3：**オレンジ背景（結果パネル全体）**

※「現在の危険」と「未来の危険」は背景色では区別せず、**バッジ文言で区別**する。

### 9-5. バッジ表示（結果パネル上部）
- S0：`OK（現在OK / 予測OK）`
- S1：`注意（予測が目標未達）`
- S2：`危険（現在が目標未達）`
- S3：`危険（現在も予測も目標未達）`

### 9-6. 結果欄での目標併記（推奨）
- 「現在までの応答率」行と「業務終了 予測応答率」行に、目標 `R_target_pct` を併記する。  
  例：`現在までの応答率 83.4%（目標 85.0%）`

---
作成日：2025-12-20 (JST)
